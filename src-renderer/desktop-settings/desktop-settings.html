<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline'">
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        color: black;
        background-color: white;
      }
      main {
        padding: 20px;
        box-sizing: border-box;
        width: 100%;
        min-height: 100vh;
        border: 20px solid hsla(0, 100%, 65%, 1);
      }
      .title {
        margin-top: 0;
      }
      label {
        display: block;
        margin: 8px 0;
      }
      .label {
        font-weight: bold;
        margin-bottom: 2px;
      }
      select {
        width: 100%;
        font: inherit;
      }
      button {
        cursor: pointer;
        font: inherit;
      }
    </style>
  </head>
  <body>
    <main>
      <script>
        const {locale, strings} = DesktopSettingsPreload.getStrings();
        document.documentElement.lang = locale;

        const settings = DesktopSettingsPreload.getSettings();
      </script>

      <h1 class="title"></h1>
      <script>document.querySelector('.title').textContent = strings['desktop-settings.title'];</script>

      <label>
        <div class="label update-checker-label"></div>
        <select class="update-checker-select" autocomplete="off">
          <option value="stable"></option>
          <option value="security"></option>
          <option value="never"></option>
        </select>
        <script>
          const updateCheckerSelect = document.querySelector('.update-checker-select');
          updateCheckerSelect.addEventListener('change', (e) => {
            DesktopSettingsPreload.setUpdateChecker(e.target.value);
          });
          updateCheckerSelect.value = settings.updateChecker;

          document.querySelector('.update-checker-label').textContent = strings['desktop-settings.update-checker'];
          updateCheckerSelect.querySelector('[value=stable]').textContent = strings['desktop-settings.notify-stable'];
          updateCheckerSelect.querySelector('[value=security]').textContent = strings['desktop-settings.notify-security'];
          updateCheckerSelect.querySelector('[value=never]').textContent = strings['desktop-settings.notify-never'];
        </script>
      </label>

      <label>
        <div class="label selected-microphone-label"></div>
        <select class="selected-microphone-select" autocomplete="off">
          <option selected disabled></option>
        </select>
        <script>
          const selectedMicrophoneSelect = document.querySelector('.selected-microphone-select');
          selectedMicrophoneSelect.addEventListener('change', (e) => {
            DesktopSettingsPreload.setMicrophone(e.target.value);
          });

          document.querySelector('.selected-microphone-label').textContent = strings['desktop-settings.microphone'];
          selectedMicrophoneSelect.firstChild.textContent = strings['desktop-settings.loading'];
        </script>
      </label>

      <label>
        <div class="label selected-camera-label"></div>
        <select class="selected-camera-select" autocomplete="off">
          <option selected disabled></option>
        </select>
        <script>
          const selectedCameraSelect = document.querySelector('.selected-camera-select');
          selectedCameraSelect.addEventListener('change', (e) => {
            DesktopSettingsPreload.setCamera(e.target.value);
          });
          selectedCameraSelect.value = settings.microphone;

          document.querySelector('.selected-camera-label').textContent = strings['desktop-settings.camera'];
          selectedCameraSelect.firstChild.textContent = strings['desktop-settings.loading'];
        </script>
      </label>

      <script>
        const createStatusMessageOption = (text) => {
          const option = document.createElement('option');
          option.selected = true;
          option.disabled = true;
          option.textContent = text;
          return option;
        };

        const addLoadingOption = (element) => {
          while (element.firstChild) {
            element.removeChild(element.firstChild);
          }
          element.appendChild(createStatusMessageOption(strings['desktop-settings.loading']));
        };

        const addOptions = (element, selected, devices) => {
          while (element.firstChild) {
            element.removeChild(element.firstChild);
          }

          if (devices.length === 0) {
            element.appendChild(createStatusMessageOption(strings['desktop-settings.no-devices']));
          } else {
            for (const device of devices) {
              const option = document.createElement('option');
              option.value = device.deviceId;
              option.textContent = device.label;
              element.appendChild(option);
            }
            if (selected) {
              element.value = selected;
            }
          }
        };

        const addErrorOption = (element, error) => {
          while (element.firstChild) {
            element.removeChild(element.firstChild);
          }
          element.appendChild(createStatusMessageOption(
            strings['desktop-settings.error'].replace('{error}', error)
          ));
        };

        const enumerate = async () => {
          return navigator.mediaDevices.enumerateDevices()
        };

        const updateLists = async () => {
          addLoadingOption(selectedCameraSelect);
          addLoadingOption(selectedMicrophoneSelect);
          try {
            const mediaDevices = await navigator.mediaDevices.enumerateDevices();
            addOptions(selectedMicrophoneSelect, settings.microphone, mediaDevices.filter((i) => i.kind === 'audioinput'));
            addOptions(selectedCameraSelect, settings.camera, mediaDevices.filter((i) => i.kind === 'videoinput'));
          } catch (error) {
            console.error(error);
            addErrorOption(selectedMicrophoneSelect, error);
            addErrorOption(selectedCameraSelect, error);
          }
        };

        updateLists();
        navigator.mediaDevices.addEventListener('devicechange', updateLists);
      </script>

      <label>
        <input type="checkbox" class="hardware-acceleration-checkbox" autocomplete="off">
        <span class="hardware-acceleration-label"></span>
        <script>
          const hardwareAcceleration = document.querySelector('.hardware-acceleration-checkbox');
          hardwareAcceleration.addEventListener('change', (e) => {
            DesktopSettingsPreload.setHardwareAcceleration(e.target.checked);
          });
          hardwareAcceleration.checked = settings.hardwareAcceleration;

          document.querySelector('.hardware-acceleration-label').textContent = strings['desktop-settings.hardware-acceleration'];
        </script>
      </label>

      <label>
        <input type="checkbox" class="background-throttling-checkbox" autocomplete="off">
        <span class="background-throttling-label"></span>
        <script>
          const backgroundThrottling = document.querySelector('.background-throttling-checkbox');
          backgroundThrottling.addEventListener('change', (e) => {
            DesktopSettingsPreload.setBackgroundThrottling(e.target.checked);
          });
          backgroundThrottling.checked = settings.backgroundThrottling;

          document.querySelector('.background-throttling-label').textContent = strings['desktop-settings.background-throttling'];
        </script>
      </label>

      <label>
        <input type="checkbox" class="bypass-cors-checkbox" autocomplete="off">
        <span class="bypass-cors-label"></span>
        <script>
          const bypassCORS = document.querySelector('.bypass-cors-checkbox');
          bypassCORS.addEventListener('change', (e) => {
            DesktopSettingsPreload.setBypassCORS(e.target.checked);
          });
          bypassCORS.checked = settings.bypassCORS;

          document.querySelector('.bypass-cors-label').textContent = strings['desktop-settings.bypass-cors'];
        </script>
      </label>

      <div>
        <button class="open-user-data"></button>
      </div>
      <script>
        const openUserData = document.querySelector('.open-user-data');
        openUserData.addEventListener('click', () => {
          DesktopSettingsPreload.openUserData();
        });

        openUserData.textContent = strings['desktop-settings.open-user-data'];
      </script>
    </main>
  </body>
</html>
